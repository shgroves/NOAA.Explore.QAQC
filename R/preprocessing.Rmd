---
title: "preprocessing"
output: html_document
date: "2024-09-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up

## Load libraries

```{r, echo=FALSE}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(sf)
```

## Set user

# Subset dataset

```{r}

user <- "Claire"
#user <- "Sarah"

```

## Set Expendition

Subset dataset based on missing values in a given column Run a conditional “if” statement based on the number of rows that either Returns a message stating no values are missing or Creates a table with the rows that are missing

```{r}

if(user == "Claire"){
  setwd("~/NOAA/NOAA.Explore.QAQC/R") 
  expedition = "EX2306_Survey_Data_20240528.csv"
  survey_df = read.csv(paste0("../../data/",expedition)) |>
    dplyr::filter(AphiaID != -999)}

if(user == "Sarah"){
  expedition = "EX2306" 
  survey_df = read.csv(paste0("C:/Users/sarah.groves/Documents/Data/EX2306/SME_clean/",expedition, "_Survey_Data_20240528.csv")) |>
    dplyr::filter(AphiaID != -999)}


# Helpful notes:
# paste0: doesn't add separators btw items else paste defaults to single space
# paste: can add optional delimiters (sep = "_")
```


# Missing Data

**Table 1.** Rows missing spatial information: Latitude
```{r Missing data Latitude, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Latitude),]

if(nrow(missing_lat) == 0)
{
  "No missing data"
} else
{
  missing_lat %>%
    dplyr::select(SurveyID, ObservationDate,ObservationTime, SampleID)
  DT::datatable(missing_lat)  
  
}
```

**Table 2.** Rows missing spatial information: Longitude
```{r Missing data Longitude, echo=FALSE}

missing_lon <- survey_df[is.na(survey_df$Longitude),]

if(nrow(missing_lon) == 0)
{
  "No missing data"
} else
{
  missing_lon %>%
    dplyr::select(SurveyID, ObservationDate,ObservationTime, SampleID)
  DT::datatable(missing_lon)  
  
}
```


**Table 3.** Rows missing spatial information: Depth (m)
```{r Missing data Depth , echo=FALSE}

missing_depth <- survey_df[is.na(survey_df$DepthInMeters),]

if(nrow(missing_depth) == 0)
{
  "No missing data"
} else
{
  missing_lon %>%
    dplyr::select(SurveyID, ObservationDate,ObservationTime, SampleID)
  DT::datatable(missing_depth)  
  
}
```
**Table 4.** Rows missing spatial information: CMECSGeoForm
```{r Missing data CMECSGeoForm, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$CMECSGeoForm),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```

**Table 5.** Rows missing identification information: ScientificName
```{r Missing data ScientificName, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$ScientificName),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```


**Table 6.** Rows missing identification information: AphiaID
```{r Missing data AphiaID, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$AphiaID),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 7.** Rows missing identification information: LifeScienceIdentifier
```{r Missing data LifeScienceIdentifier, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$LifeScienceIdentifier),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 8.** Rows missing identification information: TaxonRank
```{r Missing data TaxonRank, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$TaxonRank),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```

**Table 9.**Rows missing identification information: DepthInMeters
```{r Missing data DepthInMeters, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$DepthInMeters),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 10.** Rows missing identification information: DepthMethod
```{r Missing data DepthMethod, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$DepthMethod),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 11.** Rows missing identification information: MinimumDepthInMeters
```{r Missing data MinimumDepthInMeters, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$MinimumDepthInMeters),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 12.** Rows missing identification information: MaximumDepthInMeters
```{r Missing data MaximumDepthInMeters, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$MaximumDepthInMeters),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 13.** Rows missing temporal information: ObservationDate
```{r Missing data ObservationDate, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$ObservationDate),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 14.** Rows missing temporal information: ObservationTime
```{r Missing data ObservationTime, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$ObservationTime),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 15.** Rows missing identification information: SurveyID
```{r Missing data SurveyID, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$SurveyID),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 16.** Rows missing sensor information: Density
```{r Missing data Density, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Density),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 17.** Rows missing sensor information: Cover
```{r Missing data Cover, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Cover),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 18.** Rows missing geographical information: Habitat
```{r Missing data Habitat, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Habitat),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 19.** Rows missing geographical information: Substrate
```{r Missing data Substrate, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Substrate),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```

**Table 20.** Rows missing sensor information: Temperature
```{r Missing data Temperature, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Temperature),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 21.** Rows missing sensor information: Salinity
```{r Missing data Salinity, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Salinity),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```
**Table 22.** Rows missing sensor information: Oxygen
```{r Missing data Oxygen, echo=FALSE}

missing_lat <- survey_df[is.na(survey_df$Oxygen),]

if(nrow(missing_lat) == 0)
{
"No missing data"
} else
{
missing_lat %>%
    dplyr::select(SurveyID, ObservationDate, ObservationTime, SampleID)
DT::datatable(missing_lat)  
}
```

# Plot Data

**Fig. 1.** Histogram of annotation Latitude.  
```{r hist of annotation Latitude, fig.height = 4, fig.width = 7, echo = FALSE}

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID", "Latitude" )])

Latitude_hist <- ggplot(uniquesites, aes(x=Latitude)) + 
  geom_histogram() +
  theme_bw() + 
  xlab("Latitude")

"Summary statistics of latitude:"
summary(uniquesites$Latitude)


Latitude_hist

```

**Fig. 2.** Histogram of annotation Longitude.  
```{r hist of annotation Longitude, fig.height = 4, fig.width = 7, echo = FALSE}

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID", "Longitude" )])

Longitude_hist <- ggplot(uniquesites, aes(x=Longitude)) + 
  geom_histogram() +
  theme_bw() + 
  xlab("Longitude")
Longitude_hist

"Summary statistics of longitude:"
summary(uniquesites$Longitude)


```

**Fig. 3.** Histogram and probability distribution of Depth.  
```{r hist of depth, fig.height = 4, fig.width = 7, echo = FALSE}

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID", "DepthInMeters" )]) 


depth_hist <- ggplot(uniquesites, aes(x=DepthInMeters)) + 
  geom_histogram() +
  geom_density(alpha = 0.2) +
  theme_bw() + xlab("Depth (m)")

"Summary statistics of depth (m)"
summary(uniquesites$DepthInMeters)


depth_hist

```
**Fig. 4.** Plot of ObservationDate  
```{r plot of observation date, fig.height = 4, fig.width = 7, echo = FALSE}
options(stringsAsFactors = FALSE)

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID" )]) 
uniquesites$ObservationDate <- as.Date(uniquesites$ObservationDate, "%m/%d/%Y",) 


date_freq <- uniquesites %>%
  group_by(ObservationDate) %>%
  summarise(freq = n())

obs_date_plot <- ggplot(date_freq, aes(x = ObservationDate, y = freq)) +
                        geom_bar(stat = "identity") +
                        labs(title = "Frequency of Observations by Date", x = "Observation Date", y = "Frequency") +
                        theme_minimal() +
                        scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 day") +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))
"Summary statistics of Observation Date"
summary(uniquesites$ObservationDate)


obs_date_plot

```

**Fig. 5.** Plot of Observation Date and Time.  
```{r plot of observation time, fig.height = 4, fig.width = 7, echo = FALSE}
# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID" )]) 
uniquesites$ObservationDate <- as.Date(uniquesites$ObservationDate, "%m/%d/%Y",) 
uniquesites$ObservationTime <- as.POSIXct(uniquesites$ObservationTime, format = "%H:%M:%S")

obs_time_plot <- ggplot(uniquesites, aes(x = ObservationDate, y = ObservationTime)) +
                        geom_point() +
                        labs(title = "Observation Date vs Time", x = "Observation Date", y = "Observation Time (Hour)") +
                        theme_minimal() +
                        scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 day") +
                        scale_y_datetime(date_labels = "%H", date_breaks = "1 hour") +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))
"Summary statistics of Observation Time."
summary(uniquesites$ObservationTime)


obs_time_plot

### FIX Y AXIS ###
```

**Fig. 10.** Histogram and probability distribution of Temperature.  
```{r hist of depth, fig.height = 4, fig.width = 7, echo = FALSE}

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID", "Temperature" )]) 


temp_hist <- ggplot(uniquesites, aes(x=Temperature)) + 
  geom_histogram() +
  geom_density(alpha = 0.2) +
  theme_bw() + xlab("Temperature (C)") + ylab("Count")

"Summary statistics of Temperature (C)"
summary(uniquesites$Temperature)


temp_hist

```

**Fig. 11.** Histogram and probability distribution of Salinity.  
```{r hist of depth, fig.height = 4, fig.width = 7, echo = FALSE}

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID", "Salinity" )]) 


salinity_hist <- ggplot(uniquesites, aes(x=Salinity)) + 
  geom_histogram() +
  geom_density(alpha = 0.2) +
  theme_bw() + xlab("Salinity") + ylab("Count")

"Summary statistics of depth (m)"
summary(uniquesites$Salinity)


salinity_hist

```

**Fig. 12.** Histogram and probability distribution of Oxygen.  
```{r hist of depth, fig.height = 4, fig.width = 7, echo = FALSE}

# create unique sites
uniquesites <- unique(survey_df[, c("SurveyID", "ObservationDate", "ObservationTime", "SampleID", "Oxygen" )]) 


ox_hist <- ggplot(uniquesites, aes(x=Oxygen)) + 
  geom_histogram() +
  geom_density(alpha = 0.2) +
  theme_bw() + xlab("Oxygen") + ylab("Count")

"Summary statistics of depth (m)"
summary(uniquesites$Oxygen)


ox_hist
```


# Check Values

```{r}
print("CMECS Geoform")
print(unique(survey_df$CMECSGeoForm))

```


```{r}

print("Habitat")
print(unique(survey_df$Habitat))

```


```{r}

print("Substrate")
print(unique(survey_df$Substrate))

```


# Compare with Obis Dataset

```{r}
library(robis)
```

```{r}
get_occurences <- check_aphiaid_near_location <- function(aphiaid) {
  # Fetch occurrence data for the given AphiaID
  occurrences <- occurrence(taxonid = aphiaid)
  return(occurrences = occurrences)
}

check_distances <- function(aphiaid, occurrences, samples_df, radius = 50, print_map = FALSE){
  subset_df = samples_df[samples_df$AphiaID == aphiaid, ]
  lattitudes = subset_df$Latitude
  longitudes = subset_df$Longitude
  subset_df[, "Distance"] = NA
  if (nrow(occurrences) != 0) {
    print(nrow(occurrences))
    for (dist in 1:length(lattitudes)){
      subset_df[dist,]$Distance = min(geosphere::distHaversine(
      matrix(c(longitudes[dist], latitudes[dist]), ncol = 2),
      matrix(c(occurrences$decimalLongitude, occurrences$decimalLatitude), ncol = 2)
    ) / 1000 )
    }
  }
  return(subset_df)
}
check_aphiaid_near_location <- function(occurences, subset_df, print_map = FALSE) {
  num_found = sum(subset_df$Distance <= radius)
  # print(subset_df$Genus[1], subset_df$Species[1])
  print(paste("Found", num_found, "samples within", radius, "km"))
  if (num_found > 0){
    found = TRUE
  } else {
    found = FALSE
  }
  if (print_map) {
    map_leaflet(occurrences)
  }
  return(found)
}

aphiaids <- survey_df$AphiaID 
samples_df = survey_df %>% select(AphiaID, Genus, Species, Latitude, Longitude)
output_dir = "aphiaid/"
for (i in 1:length(aphiaids)){
  print(i)
  aphiaid = aphiaids[i]
  print(paste("Aphia ID:", aphiaid))
  occurrences <- get_occurences(aphiaid)
  subset_df <- check_distances(aphiaid, occurrences, samples_df, radius = 50)
  found <- check_aphiaid_near_location(occurrences, subset_df)
  if (found) {
    write.csv(occurrences, file = paste(output_dir, "aphiaid_",aphiaid, "_occurences.csv", sep=""))
    write.csv(subset_df, file = paste(output_dir, "aphiaid_",aphiaid, "_survey.csv", sep=""))
    # if (print_map) {
    #   map_leaflet(occurrences)
    # }
  }
}

check_aphiaid_near_location
print(results)
```



